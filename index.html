<!DOCTYPE html>
<html lang="pt-BR">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>RAT ARKLOK - JM INFORMATICA</title>
    <style>
        body {
            font-family: Arial;
            margin: 0;
            padding: 20px 5px;
            background-color: #8caad4;
        }

        h3 {
            text-align: center;
            margin-bottom: 20px;
        }

        form {
            max-width: 500px;
            margin: auto;
            background: #fff;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 0 10px rgba(0, 0, 0, 0.1);
        }

        label {
            display: block;
            margin-top: 15px;
            font-weight: bold;
        }

        input,
        textarea,
        canvas {
            width: 100%;
            padding: 12px;
            margin-top: 5px;
            font-size: 16px;
            border-radius: 5px;
            border: 1px solid #ccc;
            box-sizing: border-box;
        }

        textarea {
            resize: vertical;
            min-height: 80px;
        }

        button {
            margin-top: 20px;
            padding: 15px;
            width: 100%;
            font-size: 18px;
            background-color: #007BFF;
            color: white;
            border: none;
            border-radius: 8px;
            cursor: pointer;
        }

        button:hover {
            background-color: #0056b3;
        }

        #limparAssinatura {
            background-color: #dc3545;
            margin-top: 5px;
        }

        #limparAssinatura:hover {
            background-color: #a71d2a;
        }
    </style>
</head>

<body>
    <h3>JM INFORMÁTICA</h3>
    <h3>RAT (RELATÓRIO ATENDIMENTO TÉCNICO)</h3>
    <form id="chamadoForm">
        <label for="tecnico">NOME DO TÉCNICO:</label>
        <input type="text" id="tecnico" name="tecnico" required>

        <label for="empresa">EMPRESA PARCEIRA:</label>
        <input type="text" id="empresa" name="empresa" value="JM INFORMATICA" readonly>

        <label for="chamado">CHAMADO:</label>
        <input type="text" id="chamado" name="chamado" required>

        <label for="data">DATA DO ATENDIMENTO:</label>
        <input type="date" id="data" name="data" required>

        <label for="inicio">Horário de Início:</label>
        <input type="time" id="inicio" name="inicio" required>

        <label for="termino">Horário de Término:</label>
        <input type="time" id="termino" name="termino" required>

        <label for="assinatura">ASSINATURA DO TÉCNICO / RESPONSÁVEL:</label>
        <div style="position: relative;">
            <canvas id="assinatura" width="500" height="150" style="border:1px solid #ccc;"></canvas>
            <div
                style="position: absolute; bottom: 10px; width: 100%; text-align: center; color: #999; font-size: 16px; pointer-events: none;">
                ______ASSINE AQUI______
            </div>
        </div>
        <button type="button" id="limparAssinatura">Limpar Assinatura</button>


        <button type="button" id="btnPDF">Gerar PDF</button>
    </form>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script>
        const canvas = document.getElementById('assinatura');
        const ctx = canvas.getContext('2d');
        let desenhando = false;
        let lastX = 0, lastY = 0;

        function ajustarCanvas() {
            canvas.width = canvas.offsetWidth;
            canvas.height = 150;
            ctx.lineWidth = 2;
            ctx.lineCap = 'round';
        }
        window.addEventListener('resize', ajustarCanvas);
        ajustarCanvas();

        // --- Assinatura ---
        function desenhar(e) {
            if (!desenhando) return;
            const rect = canvas.getBoundingClientRect();
            let x = (e.touches ? e.touches[0].clientX : e.clientX) - rect.left;
            let y = (e.touches ? e.touches[0].clientY : e.clientY) - rect.top;

            const dx = x - lastX, dy = y - lastY;
            if (Math.sqrt(dx * dx + dy * dy) > 2) {
                ctx.beginPath();
                ctx.moveTo(lastX, lastY);
                ctx.lineTo(x, y);
                ctx.stroke();
                ctx.closePath();
                lastX = x; lastY = y;
            }
        }

        canvas.addEventListener('mousedown', e => { desenhando = true; const rect = canvas.getBoundingClientRect(); lastX = e.clientX - rect.left; lastY = e.clientY - rect.top; });
        canvas.addEventListener('mouseup', () => desenhando = false);
        canvas.addEventListener('mouseout', () => desenhando = false);
        canvas.addEventListener('mousemove', desenhar);

        canvas.addEventListener('touchstart', e => { desenhando = true; const rect = canvas.getBoundingClientRect(); lastX = e.touches[0].clientX - rect.left; lastY = e.touches[0].clientY - rect.top; e.preventDefault(); });
        canvas.addEventListener('touchend', () => desenhando = false);
        canvas.addEventListener('touchmove', desenhar);

        // Limpar assinatura
        document.getElementById('limparAssinatura').addEventListener('click', () => ctx.clearRect(0, 0, canvas.width, canvas.height));


        // --- Gerar PDF ---
        const { jsPDF } = window.jspdf;

        document.getElementById('btnPDF').addEventListener('click', () => {
            const form = document.getElementById('chamadoForm');
            const doc = new jsPDF({ format: 'a4', unit: 'mm' });

            let xInicio = 10;
            let y = 20;
            const larguraTotal = 190;

            // --- Título principal ---
            doc.setFontSize(14);
            doc.setFont(undefined, 'normal');
            doc.setTextColor(200, 0, 0);
            doc.text("RAT (RELATÓRIO ATENDIMENTO TÉCNICO)", 105, y, { align: "center" });
            y += 10;


            // função para criar campo
            function addCampo(x, y, largura, titulo, valor, padding = 2) {
                const altura = 8;
                const larguraTitulo = largura * 0.4;
                valor = (valor || "").toString().toUpperCase();

                doc.setDrawColor(0);
                doc.setLineWidth(0.3);
                doc.setLineDashPattern([0.3, 0.3], 0); // pontinhos menores e mais próximos

                doc.rect(x, y, largura, altura, 'S');
                doc.setLineDashPattern([], 0); // volta ao normal para outros campos


                doc.setFillColor(200, 0, 0);
                doc.rect(x, y, larguraTitulo, altura, 'F');

                doc.setFont(undefined, 'bold');
                doc.setTextColor(255, 255, 255);
                doc.setFontSize(9);
                doc.text(titulo, x + padding, y + 4.5);

                doc.setFont(undefined, 'normal');
                doc.setTextColor(0, 0, 0);
                doc.setFontSize(9);
                doc.text(valor, x + larguraTitulo + padding, y + 4.5);
            }

            // linha 1
            const larguraEmpresa = larguraTotal * 0.50;
            const larguraNome = larguraTotal * 0.50;
            addCampo(xInicio, y, larguraNome, "NOME DO TÉCNICO:", form.tecnico.value);
            addCampo(xInicio + larguraNome, y, larguraEmpresa, "EMPRESA PARCEIRA:", form.empresa.value);

            // espaçamento entre linha 1 e linha 2
            y += 10;

            // --- Linha 2 ---
            // CHAMADO = 30% | DATA DO ATENDIMENTO = 38% | HORÁRIO = 32%
            const larguraChamado = larguraTotal * 0.27;
            const larguraData = larguraTotal * 0.38; // aumenta um pouco do anterior 35%
            const larguraHorario = larguraTotal - larguraChamado - larguraData; // 32%

            // CHAMADO
            addCampo(xInicio, y, larguraChamado, "CHAMADO:", form.elements['chamado'].value, 1);

            // DATA DO ATENDIMENTO (com título com folga maior, valor menor)
            const dataInput = form.elements['data'].value;
            const partesData = dataInput.split('-');
            const dataFormatada = partesData.length === 3 ? `${partesData[2]}/${partesData[1]}/${partesData[0]}` : dataInput;

            (function addCampoData(x, y, largura, titulo, valor) {
                const altura = 8;
                const larguraTitulo = largura * 0.60; // título ocupa mais espaço
                const padding = 2;


                doc.setDrawColor(0);
                doc.setLineWidth(0.3);
                doc.setLineDashPattern([0.3, 0.3], 0); // pontinhos menores e mais próximos

                doc.rect(x, y, largura, altura, 'S');
                doc.setLineDashPattern([], 0); // volta ao normal para outros campos

                // fundo vermelho do título
                doc.setFillColor(200, 0, 0);
                doc.rect(x, y, larguraTitulo, altura, 'F');

                doc.setFont(undefined, 'bold');
                doc.setTextColor(255, 255, 255);
                doc.setFontSize(9);
                doc.text(titulo, x + padding, y + 4.5);

                // valor do campo com espaço levemente menor à direita
                const xValor = x + larguraTitulo + padding;
                const maxLarguraValor = largura - larguraTitulo - padding * 2 - 9;
                doc.setFont(undefined, 'normal');
                doc.setTextColor(0, 0, 0);
                doc.setFontSize(9);
                doc.text(valor, xValor, y + 4.3, { maxWidth: maxLarguraValor });
            })(xInicio + larguraChamado, y, larguraData, "DATA DO ATENDIMENTO:", dataFormatada);


            // --- HORÁRIO ---
            const xHorario = xInicio + larguraChamado + larguraData;
            const altura = 8;

            // Fundo vermelho do título HORÁRIO
            const larguraTituloHorario = 20;
            doc.setDrawColor(0);
            doc.setLineWidth(0.3);
            doc.setLineDashPattern([0.3, 0.3], 0); // pontinhos menores e mais próximos

            doc.rect(xHorario, y, larguraHorario, altura, 'S');
            doc.setLineDashPattern([], 0); // volta ao normal para os próximos campos


            doc.setFont(undefined, 'bold');
            doc.setTextColor(255, 255, 255);
            doc.setFillColor(200, 0, 0);
            doc.rect(xHorario, y, larguraTituloHorario, altura, 'F');
            doc.setFontSize(9);
            doc.text("HORÁRIO:", xHorario + 2, y + altura / 2 + 1.5);

            // Texto interno com gap de 1px
            doc.setFont(undefined, 'normal');
            doc.setTextColor(0, 0, 0);
            doc.setFontSize(9);

            const inicioVal = form.elements['inicio'].value;
            const terminoVal = form.elements['termino'].value;

            // largura útil disponível
            const larguraConteudo = larguraHorario - larguraTituloHorario;
            const larguraBloco = (larguraConteudo - 1) / 2;

            const yTexto = y + altura / 2 + 1.5;


            // Bloco INÍCIO
            const xInicioBloco = xHorario + larguraTituloHorario;
            doc.text("INÍCIO :", xInicioBloco + 1, yTexto);  // título mais próximo do início
            doc.text(inicioVal, xInicioBloco + 14, yTexto);  // valor mais próximo do título

            // Bloco FIM (1px de gap)
            const xFimBloco = xInicioBloco + larguraBloco + 1.3; // +1px gap entre blocos
            doc.text("FIM :", xFimBloco + 1, yTexto);        // título FIM mais próximo do início do bloco
            doc.text(terminoVal, xFimBloco + 11, yTexto);    // valor FIM mais próximo do título

            y += 15;



            // assinatura
            const imageData = canvas.toDataURL('image/png');
            if (imageData && imageData.length > 100) {
                const larguraAssinatura = 60 * 0.7;
                const alturaAssinatura = (canvas.height / canvas.width) * larguraAssinatura;

                const texto = "ASSINATURA DO TÉCNICO / RESPONSÁVEL:";
                doc.setFontSize(9);
                doc.setFont(undefined, 'normal');
                const larguraTexto = doc.getTextWidth(texto);

                const xCentro = (210 - (larguraTexto + larguraAssinatura)) / 2;
                const yBase = y + 4;

                doc.text(texto, xCentro, yBase);


                const comprimentoLinha = larguraAssinatura + 35; // aumenta 20mm
                doc.line(xCentro + larguraTexto, yBase, xCentro + larguraTexto + comprimentoLinha, yBase);

                doc.addImage(imageData, 'PNG', xCentro + larguraTexto, yBase - alturaAssinatura - 2, larguraAssinatura, alturaAssinatura);
            }

            // salvar pdf
            const chamadoNum = form.chamado.value || 'sem_numero';
            doc.save(`Chamado_${chamadoNum}.pdf`);
        });
    </script>
</body>

</html>
